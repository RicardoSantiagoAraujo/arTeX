
\newcommand{\colorsubsection}[1]{%
\colorbox{myColorSecondary!30}{\parbox{\dimexpr\textwidth-2\fboxsep}{\hspace{0.5em}#1}}}
\newcommand{\colorsubsubsection}[1]{%
\colorbox{myColorSecondary!10}{\parbox{\dimexpr\textwidth-2\fboxsep}{\hspace{0.5em}#1}}}


\newcommand{\metaInfoSettings}[1]{
    {
    \newgeometry{top=0.3cm,bottom=0.3cm,left=0cm,right=0cm} % Change the margins
    %%% STYLING META INFORMATION SECTION
    %%%%%% META-INFO PAGES PARAMETERS
    \singlespacing %spacing between lines
    \parskip=0em % spacing between paragraphs (0pt plus 1pt default)
    \parindent=0pt % indent at start of each paragraph (15 default)
    % \titlespacing*{\section}{1pt}{1pt}{1pt}
    \titlespacing*{\paragraph}{0pt}{0pt}{0.5em}
    % Format subsection titles for metadata
    %
    %
    %%% Subsection
    \titlespacing*{\subsection}{0pt}{0pt}{5pt}
    \titleformat{\subsection}
    {\vbox{\rule{1\textwidth}{1pt}\vspace{-1.5ex}}\normalsize\color{myGrayMed}\bfseries}
    {\thesubsection}
    {0.1em}
    {\colorsubsection}
    %
    %
    %
    %%% Subsubsection
    \titlespacing*{\subsubsection}{0pt}{0pt}{5pt}
    \titleformat{\subsubsection}
    {\vbox{\rule{1\textwidth}{0.1pt}\vspace{-1.4ex}}\small\color{myGrayMed}}
    {\thesubsubsection}
    {0.1em}
    {\colorsubsubsection} % change subsubsection style

    % Font size in metadata section
    \scriptsize

    %%% CONTENTS
    #1
    \clearpage
    }
}


\newcommand{\mainSourceMetadata}{
    \subsection*{Main source of information}


        \begin{myListMeta}
        %%% START WITH EMPTY ITEM
            \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
        %%% KEY
            \item[\myListLabelStyle{Main source key}]\ \expandafter\detokenize\expandafter{\mainSourceKey}
        %%% TITLE
            \myCiteEntryWithLabel{\mainSourceKey}{title}[][]%
            \myCite{\mainSourceKey}% Include citation
        %%% DOI
            \myCiteEntryWithLabel{\mainSourceKey}{doi}[DOI][]%
        %%% ISSN
            \myCiteEntryWithLabel{\mainSourceKey}{issn}[ISSN][]%
        %%% url
            \myCiteEntryWithLabel{\mainSourceKey}{url}[URL][]%
        %%% Language
            \myCiteEntryWithLabel{\mainSourceKey}{language}[][]%
        %%% Publication date
            \myCiteEntryWithLabel{\mainSourceKey}{year}[][]%
            \myCiteEntryWithLabel{\mainSourceKey}{month}[][]%
        %%% authors(s)
            \myCiteEntryWithLabel{\mainSourceKey}{author}[][]%
        %%% Journal
            \myCiteEntryWithLabel{\mainSourceKey}{journaltitle}[Journal:][]%
        %%% Volume
            \myCiteEntryWithLabel{\mainSourceKey}{volume}[][]%
        %%% Pages
            \myCiteEntryWithLabel{\mainSourceKey}{pages}[][]%
        %%% Abstract
            \myCiteEntryWithLabel{\mainSourceKey}{abstract}[][]%
        \end{myListMeta}
}


\newcommand{\myArticleMetadata}{
    \subsection*{Mediation paper}

    \begin{addmargin}
        [1em] % LEFT
        {1em} % RIGHT
        To cite: \fullcite{\myarticleKey}
        \\
    \end{addmargin}

    \begin{myListMeta}
        %%% START WITH EMPTY ITEM
        \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
        %%% TITLE
        \myCiteEntryWithLabel{\myarticleKey}{title}[][]%
        %%% SUBTITLE
        \myCiteEntryWithLabel{\myarticleKey}{subtitle}[][]%
        %%% DISCIPLINE(S)
        \myCiteEntryWithLabel{\myarticleKey}{discipline}[Disciplines:][]%
        %%% ABSTRACT
        \myCiteEntryWithLabel{\myarticleKey}{abstract}[Summary:][]%
        %%% KEYWORD(S)
        \myCiteEntryWithLabel{\myarticleKey}{keywords}[][]%
    \end{myListMeta}

    %%%%% MEDIATION CONTRIBUTOR(S):
    \subsubsection*{Credits  \& Contributions}
    \begin{myListMeta}
        %%% START WITH EMPTY ITEM
        \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
        %%% AUTHOR(S)
        \myCiteEntryWithLabel{\myarticleKey}{author}[][]%
        %%% ILLUSTRATOR(S)
        \myCiteEntryWithLabel{\myarticleKey}{illustrator}[][]%
        %%% REVIEWER(S)
        \myCiteEntryWithLabel{\myarticleKey}{reviewer}[][]%
        %%% THANKS
        \myCiteEntryWithLabel{\myarticleKey}{thank}[][]%
        %%% COPYRIGHT
        \myCiteEntryWithLabel{\myarticleKey}{copyright}[][]%
    \end{myListMeta}
    %%%%% TARGET:
    \subsubsection*{Target specifications}
    \begin{myListMeta}
        %%% START WITH EMPTY ITEM
        \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
        %%% TARGET PUBLICATION:
        \myCiteEntryWithLabel{\myarticleKey}{targetPublication}[Target publication: ][]
        %%% AUDIENCE LEVEL:
        \myCiteEntryWithLabel{\myarticleKey}{audienceLevel}[Audience level: ][]
        % environment where entries are always shown:
        \begin{alwaysShowMeta}
            %%% WORD LIMITS:
            \myCiteEntryWithLabel{\myarticleKey}{wordMin}[World limits: ][]
            ---
            \myCiteEntry{\myarticleKey}{wordMax}
            %%% CHARACTER LIMITS:
            \myCiteEntryWithLabel{\myarticleKey}{charMin}[Character limits: ][]
            ---
            \myCiteEntry{\myarticleKey}{charMax}
        \end{alwaysShowMeta}
    \end{myListMeta}
}

%%% Environment where metadata is always shown, regardless of settings
\newenvironment{alwaysShowMeta}{
    \begingroup%
    \booltrue{isIncludeMissingBibEntries} % Set boolean to true at start
}
{%
    \endgroup% Revert to previous value at end
}%


\newcommand{\myLuatexMessage}{
    \ifluatex \directlua{tex.print(status.banner)}
    \else \textcolor{myColorWarning}{This document was not compiled with \textbf{Lua\TeX}}
    \fi
}

\newcommand{\technicalMetadata}{
    \subsection*{Technical data}
    \begin{myListMeta}
        %
        \item[\myListLabelStyle{Compilation date:}]\ \today
        %
        \item[\myListLabelStyle{Compilation time:}]\ \DTMcurrenttime
        %
        \item[\myListLabelStyle{Compilation duration:}] \elapsedInt.\elapsedFrac\ seconds (previous single run)
        %
        \item[\myListLabelStyle{Lua\TeX\ version:}] \myLuatexMessage
        %
        \item[\myListLabelStyle{Paper format:}] \csname Gm@paper\endcsname
        %
        \item[\myListLabelStyle{Geometry:}] \myGeometrySettingsInfo
        %
    \end{myListMeta}
}


\newcommand{\docOptionsItem}[1]{%
    \isPortfolio{}{%
        \item[\myListLabelStyle{#1}]\ \ifthenelse{\boolean{#1}}{\textcolor{myColorSuccess}{true}}{\textcolor{myColorDanger}{false}}%
    }%
}%

\newcommand{\docOptionsMetadata}{
    \subsection*{Document options}
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%% FIRST COLUMN
    \begin{minipage}[t]{0.40\textwidth} % Adjust width as needed
        \begin{myListMeta}[
            leftmargin=70pt,
            labelsep=0pt
            ]
            %%% START WITH EMPTY ITEM
            \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
            %
            \item[\myListLabelStyle{Article key (core)}]\ \myarticleKeyCore
            \item[\myListLabelStyle{Article key (full)}]\ myarticle:\myarticleKeyCore:\myLanguage
            \item[\myListLabelStyle{Language}]\ \myLanguageLong (\myLanguage)
            \item[] % empty gap
            %
            \docOptionsItem{isMinimal}
            %
            \docOptionsItem{isDraft}
            %
            \docOptionsItem{isLandscapeMode}
            %
            \docOptionsItem{isSplitInTwoColumns}
            %
            \docOptionsItem{isPrintVersion}
            %
            \docOptionsItem{isDrawRibbons}
            %
            \docOptionsItem{isIncludeMeta}
            %
            \docOptionsItem{isIncludeArticleCover}
            %
        \end{myListMeta}
    \end{minipage}
    % \hfill % This adds space between the minipages
    %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%% SECOND COLUMN
    \begin{minipage}[t]{0.30\textwidth}
        \begin{myListMeta}[
            leftmargin=40pt,
            labelsep=0pt
            ]
            %%% START WITH EMPTY ITEM
            \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
            %
            \docOptionsItem{isIncludeToC}
            %
            \docOptionsItem{isIncludeLoF}
            %
            \docOptionsItem{isIncludeLoT}
            %
            \docOptionsItem{isIncludeLoTB}
            %
            \docOptionsItem{isIncludeBiblio}
            %
            \docOptionsItem{isIncludeGlossary}
            %
            \docOptionsItem{isIncludeAbreviations}
            %
            \docOptionsItem{isPrintUnusedGlossary}
            %
            \docOptionsItem{isPrintUnusedAbreviations}
            %
            \docOptionsItem{isHighlightGlossaryAndAbreviations}
            %
            \docOptionsItem{isIncludeMissingBibEntries}
            %
        \end{myListMeta}
    \end{minipage}
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    %%%%% THIRD COLUMN
    \begin{minipage}[t]{0.30\textwidth}
        \begin{myListMeta}[
            leftmargin=40pt,
            labelsep=0pt
            ]
            %%% START WITH EMPTY ITEM
            \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
            %
            \docOptionsItem{isIncludeFootnotes}
            %
            \docOptionsItem{isIncludeCitations}
            %
            \docOptionsItem{isIncludeCitationsInFootnotes}
            %
            \docOptionsItem{isIncludeTextBoxes}
            %
            \docOptionsItem{isMoveTextBoxesToEndOfArticle}
            %
            \docOptionsItem{isConstrainFloats}
            %
            \docOptionsItem{isIncludeArticleCoverImgInBody}
            %
            \docOptionsItem{isCreditsInArticleBody}
            %
            \docOptionsItem{hidecontentswitch}
            %
            \docOptionsItem{revealhiddenswitch}
            %
            \isPortfolio{}{\item[\myListLabelStyle{Contents version}]\ \version}
        \end{myListMeta}
    \end{minipage}


    \isPortfolio{}% do not include if portfolio
    {
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        %%% INCLUDED SECTIONS
        \subsubsection*{Components included}
        %
        \begin{myListMeta}
            %%% START WITH EMPTY ITEM
            \hiddenitem % EMPTY ITEM NECESSARY TO AVOID ERROR
            \foreach \file in \filesToAdd {
                \item             \expandafter\detokenize\expandafter{\file}%
            }%
        \end{myListMeta}%
        \ifthenelse{\equal{\filesToAdd}{}}{\textcolor{myColorDanger}{No components included}}{}%
        %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
        %%% PORTFOLIO APPENDIX ITEMS
        \subsubsection*{Appendix entries\ %
        \ifthenelse{\boolean{isIncludeAppendix}}{}{\textsuperscript{\textcolor{myColorDanger}{\tiny APPENDIX EXCLUDED}}}
        }
        \ifthenelse{\not\equal{\appendixList}{}}% if appendix is empty, return false}
        {%
            \begin{myListMeta}
                \foreach \entries [count=\n] in \appendixList {
                    \item[\myListLabelStyle{\makeAlph{\n}}] %
                    \hyperlink{appendix:target:\n}{\expandafter\detokenize\expandafter{\entries}}%
                }
            \end{myListMeta}
        }
        {%
            \hspace{1cm}\textcolor{myColorDanger}{No appendix entries selected}
        }
    }
}


\newcommand{\addMetadata}{
    \ifthenelse{\boolean{isIncludeMeta}}%
    {%
    \updateRibbons{Article: \textbf{\myCiteEntry{\myarticleKey}{title}}\ribbonSpacer Meta-information}{META-INFORMATION}
        \metaInfoSettings{
            {
                \mySectionTitle{Meta-info}

                %%%%%%
                %%%%%% TECHNICAL:
                \isPortfolio{}{\technicalMetadata}
                %%%%%%
                %%%%%% DOCUMENT OPTIONS:
                \docOptionsMetadata
                %%%%%%
                %%%%%% MAIN SOURCE INFO:
                \mainSourceMetadata
                %%%%%%
                %%%%%% MEDIATION PAPER:
                \myArticleMetadata
                %%%%%%
                %%%%%% COUNTERS:
                \countersList
            }
        }%
    }%
}